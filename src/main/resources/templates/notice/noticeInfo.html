<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            text-align: center;
            margin: 0 auto;
            padding: 20px;
        }

        .review-content {
            width: 100%;
            height: 150px;
            padding: 10px;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f9fa;
            resize: vertical;
            outline: none;
        }

        .card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            box-sizing: border-box;
            text-align: left;
        }

        .card-header {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            margin: -20px -20px 20px -20px;
        }

        .card-content {
            margin-bottom: 20px;
        }

        .card-content h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .card-content p {
            margin: 10px 0;
        }

        .btn-group {
            text-align: center;
        }

        .btn-group button {
            background-color: #007bff;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .btn-group button:hover {
            background-color: #0056b3;
        }

        .btn-group button[type="reset"] {
            background-color: #6c757d;
        }

        .btn-group button[type="reset"]:hover {
            background-color: #5a6268;
        }

        #btnDelete {
            background-color: #dc3545;
        }

        #btnDelete:hover {
            background-color: #c82333;
        }

        #comments {
            margin-bottom: 20px;
        }

        #comments .comment-item {
            margin-top: 10px;
        }

        #comments .comment-item .card-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #comments .comment-item .comment-content {
            flex-grow: 1;
        }

        #comments .comment-item .btn-group {
            display: flex;
            gap: 5px;
        }

        #content {
            width: calc(100% - 160px);
            height: 30px;
            resize: none;
            padding: 10px;
            box-sizing: border-box;
            vertical-align: middle;
        }

        #btnSend {
            background-color: #ffc107;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #btnSend:hover {
            background-color: #e0a800;
        }

        #btnLike {
            background-color: #28a745;
        }

        #btnLike:hover {
            background-color: #218838;
        }
    </style>
    <script type="text/javascript" src="/js/jquery-3.6.0.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const session_user_id = [[${session.SS_USER_ID}]];
        const user_id = [[${rDTO.userId}]];
        const nSeq = [[${rDTO.noticeSeq}]];

        $(document).ready(function () {
            $("#btnEdit, #btnList").on("click", function () {
                const id = $(this).attr('id');
                if (id === "btnEdit") {
                    doEdit();
                } else if (id === "btnList") {
                    location.href = "/notice/noticeList";
                }
            });

            $("#btnDelete").on("click", function () {
                doDelete();
            });

            $("#btnSend").on("click", function () {
                doInsertComment();
            });

            $("#btnLike").on("click", function () {
                toggleLike();
            });

            // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¢ãÏïÑÏöî Ïàò Í∞ÄÏ†∏Ïò§Í∏∞
            fetchLikeCount();
        });

        function doEdit() {
            if (session_user_id === user_id) {
                location.href = "/notice/noticeEditInfo?nSeq=" + nSeq;
            } else if (session_user_id === "") {
                alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.");
            } else {
                alert("Î≥∏Ïù∏Ïù¥ ÏûëÏÑ±Ìïú Í∏ÄÎßå ÏàòÏ†ï Í∞ÄÎä•Ìï©ÎãàÎã§.");
            }
        }

        function doDelete() {
            if (session_user_id === user_id) {
                if (confirm("ÏûëÏÑ±Ìïú Í∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    $.ajax({
                        url: "/notice/noticeDelete",
                        type: "post",
                        dataType: "JSON",
                        data: {"nSeq": nSeq},
                        success: function (json) {
                            alert(json.msg);
                            location.href = "/notice/noticeList";
                        }
                    });
                }
            } else if (session_user_id === "") {
                alert("Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.");
            } else {
                alert("Î≥∏Ïù∏Ïù¥ ÏûëÏÑ±Ìïú Í∏ÄÎßå ÏÇ≠Ï†ú Í∞ÄÎä•Ìï©ÎãàÎã§.");
            }
        }

        function doInsertComment() {
            const comment = $("#content").val();
            if (!comment) {
                alert("ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                return;
            }

            $.ajax({
                url: "/comment/commentInsert",
                type: "post",
                dataType: "JSON",
                data: {
                    "comment": comment,
                    "noticeSeq": nSeq
                },
                success: function (json) {
                    alert(json.msg);
                    location.href = "/notice/noticeInfo?nSeq=" + nSeq;
                }
            });
        }

        function toggleLike() {
            $.ajax({
                url: "/like/toggle",
                type: "post",
                contentType: "application/json",
                data: JSON.stringify({
                    noticeSeq: nSeq,
                    userId: session_user_id
                }),
                success: function (response) {
                    alert(response);
                    fetchLikeCount();
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                    alert("Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                }
            });
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¢ãÏïÑÏöî Ïàò Í∞ÄÏ†∏Ïò§Í∏∞
        function fetchLikeCount() {
            $.ajax({
                url: "/like/count",
                type: "get",
                data: {
                    noticeSeq: nSeq
                },
                success: function (response) {
                    $("#likeCount").text(response);
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                    alert("Ï¢ãÏïÑÏöî Ïàò Í∞ÄÏ†∏Ïò§Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                }
            });
        }

        $(document).ready(function () {
            $("#btnLike").off("click").on("click", function () {
                $(this).prop('disabled', true); // Î≤ÑÌäº ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ Ï§ëÎ≥µ ÌÅ¥Î¶≠ Î∞©ÏßÄ
                toggleLike();
                $(this).prop('disabled', false); // ÏöîÏ≤≠ ÏôÑÎ£å ÌõÑ Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
            });
        });


        function EditCommentSeq(element) {
            var commentSeq = element.getAttribute('data-comment-seq');
            var userId = element.getAttribute('data-user-id');
            var newComment = prompt("ÏàòÏ†ïÌï† ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", "");
            if (newComment !== null) {
                if (newComment.trim() === "") {
                    alert("ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                } else {
                    $.ajax({
                        url: "/comment/commentUpdate",
                        type: "post",
                        dataType: "JSON",
                        data: {
                            "noticeSeq": nSeq,
                            "commentSeq": commentSeq,
                            "comment": newComment
                        },
                        success: function (json) {
                            alert(json.msg);
                            location.reload();
                        }
                    });
                }
            }
        }

        function DeleteCommentSeq(element) {
            var commentSeq = element.getAttribute('data-comment-seq');
            var userId = element.getAttribute('data-user-id');
            if (session_user_id === userId) {
                if (confirm("ÏûëÏÑ±Ìïú ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    $.ajax({
                        url: "/comment/commentDelete",
                        type: "post",
                        dataType: "JSON",
                        data: {
                            "commentSeq": commentSeq,
                            "noticeSeq": nSeq,
                            "userId": userId
                        },
                        success: function (json) {
                            alert(json.msg);
                            location.href = "/notice/noticeInfo?nSeq=" + nSeq;
                        }
                    });
                }
            } else if (session_user_id === "") {
                alert("Î°úÍ∑∏Ïù∏ ÌïòÏãúÍ∏∏ Î∞îÎûçÎãàÎã§.");
            } else {
                alert("Î≥∏Ïù∏Ïù¥ ÏûëÏÑ±Ìïú Í∏ÄÎßå ÏÇ≠Ï†ú Í∞ÄÎä•Ìï©ÎãàÎã§.");
            }
        }
        /*]]>*/
    </script>
</head>
<body>
<div class="card">
    <div class="card-header">Í≥µÏßÄÏÇ¨Ìï≠ ÏÉÅÏÑ∏</div>
    <div class="card-content">
        <h3>Ï†úÎ™©</h3>
        <p th:text="${rDTO.title}"></p>
    </div>
    <div class="card-content">
        <h3>ÏûëÏÑ±Ïùº</h3>
        <p th:text="${rDTO.regDt}"></p>
    </div>
    <div class="card-content">
        <h3>Ï°∞ÌöåÏàò</h3>
        <p th:text="${rDTO.readCnt}"></p>
    </div>
    <div class="card-content">
        <h3>ÎÇ¥Ïö©</h3>
        <textarea class="review-content" readonly th:text="${rDTO.contents}"></textarea>
    </div>
    <hr>

    <div class="btn-group">
        <button id="btnEdit" type="button">ÏàòÏ†ï</button>
        <button id="btnDelete" type="button">ÏÇ≠Ï†ú</button>
        <button id="btnList" type="button">Î™©Î°ù</button>
    </div>
    <!-- Ï¢ãÏïÑÏöî Î≤ÑÌäº -->
    <div class="btn-group" style="margin-top: 20px;">
        <button id="btnLike" type="button" class="btn btn-light">
            üëç <span id="likeCount">0</span>
        </button>
    </div>
</div>
<!-- ÎåìÍ∏Ä ÏûÖÎ†• Ìèº -->
<div class="card my-4" style="box-shadow: none;">
    <div class="card-body">
        <form name="f" id="f">
            <div class="form-group" style="display: flex; align-items: center;">
                <textarea class="form-control" name="content" id="content" style="flex: 1;" rows="1" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî." required></textarea>
                <button id="btnSend" type="button" class="btn btn-warning" style="margin-left: 10px;">ÏûëÏÑ±</button>
            </div>
            <input type="hidden" name="noticeSeq" th:value="${rDTO.noticeSeq}"/>
        </form>
    </div>
</div>

<!-- ÎåìÍ∏Ä Î™©Î°ù -->
<div id="comments">
    <div th:each="dto : ${rList}" class="comment-item">
        <div class="card card-body mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="comment-content">
                    <h5 class="mb-0" th:text="${dto.userId}">ÏûëÏÑ±Ïûê Ïù¥Î¶Ñ</h5>
                    <p class="mb-0" style="white-space: pre-wrap;" th:text="${dto.comment}">ÎåìÍ∏Ä ÎÇ¥Ïö©</p>
                    <p class="mb-0" th:text="${dto.regDt}">ÏûëÏÑ± ÏãúÍ∞Ñ</p>
                </div>
                <div class="btn-group" th:if="${dto.userId eq session.SS_USER_ID}">
                    <button type="button" class="btn btn-sm btn-primary" th:onclick="'EditCommentSeq(this)'" th:attr="data-comment-seq=${dto.commentSeq}, data-user-id=${dto.userId}">ÏàòÏ†ï</button>
                    <button type="button" class="btn btn-sm btn-danger" th:onclick="'DeleteCommentSeq(this)'" th:attr="data-comment-seq=${dto.commentSeq}, data-user-id=${dto.userId}">ÏÇ≠Ï†ú</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
